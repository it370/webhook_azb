<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aizawl Bazaar Admin</title>
    <style>
      :root {
        font-family: Arial, sans-serif;
        background: #f7f7f8;
        color: #222;
      }
      body {
        margin: 0;
      }
      h1 {
        margin: 0 0 0.25rem 0;
      }
      .layout {
        display: grid;
        grid-template-columns: 240px 1fr;
        min-height: 100vh;
      }
      .sidebar {
        background: #0f172a;
        color: #e2e8f0;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .sidebar h2 {
        margin: 0;
        font-size: 1.1rem;
      }
      .sidebar .nav button {
        width: 100%;
        text-align: left;
        background: #1e293b;
        border: 1px solid #243049;
        color: #e2e8f0;
        padding: 0.65rem 0.8rem;
        border-radius: 8px;
        cursor: pointer;
      }
      .sidebar .nav button:hover {
        background: #23314d;
      }
      .main {
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        overflow-y: auto;
      }
      .section-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1rem;
      }
      .card {
        background: #fff;
        border: 1px solid #e3e3e3;
        border-radius: 10px;
        padding: 1rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      }
      .card h2 {
        margin-top: 0;
        margin-bottom: 0.75rem;
      }
      label {
        display: block;
        margin-bottom: 0.25rem;
        font-weight: 600;
      }
      textarea,
      input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #d0d0d0;
        border-radius: 6px;
      }
      button {
        margin-top: 0.5rem;
        padding: 0.6rem 1rem;
        border: none;
        border-radius: 6px;
        background: #2563eb;
        color: #fff;
        font-weight: 600;
        cursor: pointer;
      }
      button:disabled {
        background: #9ab6f7;
        cursor: not-allowed;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
      }
      th,
      td {
        border: 1px solid #e5e5e5;
        padding: 0.5rem;
        vertical-align: top;
      }
      th {
        background: #f0f4ff;
        text-align: left;
      }
      code {
        background: #f3f3f3;
        padding: 0.1rem 0.2rem;
        border-radius: 4px;
      }
      .muted {
        color: #555;
        font-size: 0.9rem;
      }
      .pill {
        display: inline-block;
        padding: 0.2rem 0.5rem;
        border-radius: 999px;
        background: #eef2ff;
        color: #3730a3;
        font-weight: 600;
        font-size: 0.85rem;
      }
      .row {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
      }
      pre {
        white-space: pre-wrap;
        word-break: break-word;
        background: #f6f8fa;
        padding: 0.75rem;
        border-radius: 6px;
        border: 1px solid #e5e5e5;
        max-height: 220px;
        overflow: auto;
      }
      @media (max-width: 800px) {
        .layout {
          grid-template-columns: 1fr;
        }
        .sidebar {
          flex-direction: row;
          gap: 0.75rem;
          align-items: center;
          flex-wrap: wrap;
        }
        .sidebar .nav {
          display: flex;
          flex-wrap: wrap;
          gap: 0.5rem;
        }
        .sidebar .nav button {
          width: auto;
        }
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <aside class="sidebar">
        <div>
          <h1 style="font-size:1.3rem;">Aizawl Bazaar Admin</h1>
          <div class="muted">Test, monitor, and inspect data.</div>
        </div>
        <div class="nav">
          <button class="nav-btn" data-target="test-card" type="button">Quick test</button>
          <button class="nav-btn" data-target="orders-card" type="button">Orders</button>
          <button class="nav-btn" data-target="products-card" type="button">Products</button>
          <button class="nav-btn" data-target="inbox-card" type="button">Inbox</button>
          <button class="nav-btn" data-target="reply-card" type="button">Reply</button>
          <button class="nav-btn" data-target="events-card" type="button">Webhook events</button>
        </div>
      </aside>
      <main class="main">
        <div class="section-row">
          <div class="card" id="test-card">
            <h2>Quick Test</h2>
            <form id="test-form">
              <label for="test-text">Message text</label>
              <textarea id="test-text" rows="4" placeholder="e.g., I want a chocolate cake"></textarea>
              <button id="test-button" type="submit">Send to bot</button>
            </form>
            <div id="test-result" class="muted" style="margin-top: 0.75rem;"></div>
          </div>

          <div class="card" id="orders-card">
            <h2>Pending Orders</h2>
            <div class="row" style="margin-bottom: 0.5rem;">
              <button id="refresh-orders" type="button">Refresh</button>
            </div>
            <div id="orders-body" class="muted">Loading...</div>
          </div>
        </div>

        <div class="section-row">
          <div class="card" id="products-card">
            <h2>Products (up to 100)</h2>
            <div class="row" style="margin-bottom: 0.5rem;">
              <button id="load-products" type="button">Load products</button>
            </div>
            <div class="muted" style="margin-bottom:0.5rem;">
              Requires Supabase service role credentials. Shows id, name, price, stock, vendor, location.
            </div>
            <div id="products-body" class="muted">Not loaded.</div>
          </div>
        </div>

        <div class="section-row">
          <div class="card" id="inbox-card">
            <h2>Inbox (WhatsApp)</h2>
            <div class="muted" style="margin-bottom:0.5rem;">Recent inbound messages (from webhook events).</div>
            <div id="inbox-body" class="muted">Loading...</div>
          </div>

          <div class="card" id="reply-card">
            <h2>Send Reply (24h window)</h2>
            <form id="reply-form">
              <label for="reply-to">Recipient phone (E.164, e.g., 91xxxxxxxxxx)</label>
              <input id="reply-to" type="text" placeholder="+91..." />
              <label for="reply-text">Message</label>
              <textarea id="reply-text" rows="3" placeholder="Type a non-template message"></textarea>
              <button id="reply-button" type="submit">Send</button>
            </form>
          </div>
        </div>

        <div class="card" id="events-card">
          <div class="row" style="justify-content: space-between;">
            <h2 style="margin: 0;">Recent Webhook Events</h2>
            <div class="row">
              <button id="refresh-events" type="button">Refresh</button>
            </div>
          </div>
          <div id="events-table" style="margin-top: 0.5rem;" class="muted">
            Loading...
          </div>
        </div>
      </main>
    </div>

    <script>
      const testForm = document.getElementById("test-form");
      const testText = document.getElementById("test-text");
      const testResult = document.getElementById("test-result");
      const testButton = document.getElementById("test-button");
      const eventsTable = document.getElementById("events-table");
      const refreshEventsBtn = document.getElementById("refresh-events");
      const ordersBody = document.getElementById("orders-body");
      const refreshOrdersBtn = document.getElementById("refresh-orders");
      const loadProductsBtn = document.getElementById("load-products");
      const productsBody = document.getElementById("products-body");
      const inboxBody = document.getElementById("inbox-body");
      const replyForm = document.getElementById("reply-form");
      const replyToInput = document.getElementById("reply-to");
      const replyTextInput = document.getElementById("reply-text");
      const replyButton = document.getElementById("reply-button");
      const navButtons = Array.from(document.querySelectorAll(".nav-btn"));

      async function runTest(e) {
        e.preventDefault();
        const text = testText.value.trim();
        if (!text) {
          testResult.textContent = "Enter a message first.";
          return;
        }
        setLoading(testButton, true);
        testResult.textContent = "Running...";
        try {
          const res = await fetch("/admin/api/test", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text }),
          });
          const data = await res.json();
          if (!res.ok) {
            throw new Error(data.error || "Test failed");
          }
          const products = data.products || [];
          const productLines = products
            .map((p) => `- ${p.name} (${p.vendor_name || p.vendor?.name || "Unknown"})`)
            .join("\\n");
          testResult.innerHTML = `
            <div><span class="pill">Reply</span> ${escapeHtml(data.reply || "")}</div>
            ${
              products.length
                ? `<div style="margin-top:0.4rem;"><span class="pill">Products</span><pre>${escapeHtml(productLines)}</pre></div>`
                : ""
            }
          `;
          await Promise.all([loadEvents(), loadOrders()]);
        } catch (err) {
          testResult.textContent = err.message;
        } finally {
          setLoading(testButton, false);
        }
      }

      function renderEvents(events = []) {
        if (!events.length) {
          eventsTable.textContent = "No events yet.";
          return;
        }
        const rows = events
          .map(
            (e) => `
            <tr>
              <td>${escapeHtml(e.createdAt || "")}</td>
              <td>${escapeHtml(e.source || "webhook")}</td>
              <td><code>${escapeHtml(e.incomingText || "")}</code></td>
              <td>${escapeHtml(e.reply || e.error || "")}</td>
              <td>${Array.isArray(e.products) ? e.products.length : 0}</td>
            </tr>
          `
          )
          .join("");
        eventsTable.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Time</th>
                <th>Source</th>
                <th>Incoming</th>
                <th>Reply / Error</th>
                <th># Products</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      }

      function renderInbox(events = []) {
        const inbound = events.filter((e) => e.incomingText && e.from);
        if (!inbound.length) {
          inboxBody.textContent = "No inbound messages yet.";
          return;
        }
        const rows = inbound
          .map(
            (e) => `
              <tr>
                <td>${escapeHtml(e.createdAt || "")}</td>
                <td>${escapeHtml(e.from || "")}</td>
                <td><code>${escapeHtml(e.incomingText || "")}</code></td>
                <td>
                  <button type="button" class="pill" onclick="prefillReply('${escapeHtml(
                    e.from || ""
                  )}', '${escapeHtml(e.incomingText || "").replace(/'/g, "\\'")}')">Reply</button>
                </td>
              </tr>
            `
          )
          .join("");
        inboxBody.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Time</th>
                <th>From</th>
                <th>Message</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      }

      async function sendReply(e) {
        e.preventDefault();
        const to = replyToInput.value.trim();
        const text = replyTextInput.value.trim();
        if (!to || !text) {
          alert("Both recipient and message are required.");
          return;
        }
        setLoading(replyButton, true, "Sending...");
        try {
          const res = await fetch("/admin/api/reply", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ to, text }),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Failed to send.");
          replyTextInput.value = "";
          await loadEvents();
        } catch (err) {
          alert(err.message);
        } finally {
          setLoading(replyButton, false);
        }
      }

      function renderOrders(orders = []) {
        if (!orders.length) {
          ordersBody.textContent = "No pending orders logged.";
          return;
        }
        const rows = orders
          .map(
            (o) => `
              <div style="margin-bottom:0.5rem;">
                <div><span class="pill">Order</span> ${escapeHtml(o.id || "")}</div>
                <div class="muted">${escapeHtml(o.requestedProduct || "")}</div>
                <div class="muted">${escapeHtml(o.status || "")} • ${escapeHtml(
              o.createdAt || ""
            )}</div>
              </div>
            `
          )
          .join("");
        ordersBody.innerHTML = rows;
      }

      async function loadEvents() {
        eventsTable.textContent = "Loading...";
        try {
          const res = await fetch("/admin/api/events");
          const data = await res.json();
          renderEvents(data.events || []);
          renderInbox(data.events || []);
        } catch (err) {
          eventsTable.textContent = "Failed to load events.";
        }
      }

      async function loadOrders() {
        ordersBody.textContent = "Loading...";
        try {
          const res = await fetch("/admin/api/orders");
          const data = await res.json();
          renderOrders(data.orders || []);
        } catch (err) {
          ordersBody.textContent = "Failed to load orders.";
        }
      }

      async function loadProducts() {
        productsBody.textContent = "Loading...";
        setLoading(loadProductsBtn, true, "Loading...");
        try {
          const res = await fetch("/admin/api/products?limit=100");
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Failed to load products.");
          renderProducts(data.products || []);
        } catch (err) {
          productsBody.textContent = err.message;
        } finally {
          setLoading(loadProductsBtn, false);
        }
      }

      function renderProducts(products = []) {
        if (!products.length) {
          productsBody.textContent = "No products found (check Supabase creds).";
          return;
        }
        const rows = products
          .map((p) => {
            const vendor = p.vendor?.name || "Unknown";
            const loc = p.vendor?.veng_location || "";
            const price = p.price != null ? `₹${p.price}` : "N/A";
            const stock = p.stock_status === false ? "out" : "in";
            return `
              <tr>
                <td>${escapeHtml(p.id || "")}</td>
                <td>${escapeHtml(p.name || "")}</td>
                <td>${escapeHtml(price)}</td>
                <td>${escapeHtml(stock)}</td>
                <td>${escapeHtml(vendor)}</td>
                <td>${escapeHtml(loc)}</td>
              </tr>
            `;
          })
          .join("");
        productsBody.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Price</th>
                <th>Stock</th>
                <th>Vendor</th>
                <th>Location</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      }

      function escapeHtml(value) {
        return String(value || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function setLoading(button, state, label = "Working...") {
        button.disabled = state;
        if (state) {
          button.dataset.prev = button.textContent;
          button.textContent = label;
        } else {
          button.textContent = button.dataset.prev || "Send";
        }
      }

      function scrollToSection(id) {
        const el = document.getElementById(id);
        if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      window.prefillReply = (to, message) => {
        replyToInput.value = to;
        replyTextInput.value = `Re: ${message}`;
        scrollToSection("reply-card");
      };

      navButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const target = btn.dataset.target;
          if (target) scrollToSection(target);
        });
      });

      testForm.addEventListener("submit", runTest);
      refreshEventsBtn.addEventListener("click", loadEvents);
      refreshOrdersBtn.addEventListener("click", loadOrders);
      loadProductsBtn.addEventListener("click", loadProducts);
      replyForm.addEventListener("submit", sendReply);

      loadEvents();
      loadOrders();
    </script>
  </body>
</html>

